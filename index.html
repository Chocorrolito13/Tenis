<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const contenedor = document.getElementById("lista-productos");

    // Margen de ganancia sugerido según tipo de tenis
    const MARGEN_PRODUCTO = (title) => {
      const t = title.toLowerCase();
      if (t.includes("premium") || t.includes("retro") || t.includes("limited")) return 0.50;
      if (t.includes("air") || t.includes("max") || t.includes("force")) return 0.40;
      return 0.35;
    };

    async function cargarProductos() {
      let productos = [];
      let page = 1;
      let seguir = true;

      while (seguir) {
        try {
          const res = await fetch(`https://snkrsmayoreo.mx/collections/modelos-disponibles-1/products.json?limit=250&page=${page}`);
          const data = await res.json();

          if (!data.products || data.products.length === 0) {
            seguir = false;
            break;
          }

          const nuevos = data.products.map(p => {
            const costo = p.variants[0]?.price ? parseFloat(p.variants[0].price) : 0;
            const margen = MARGEN_PRODUCTO(p.title);
            const precioFinal = (costo / (1 - margen)).toFixed(2);

            const tallas = p.variants
              .filter(v => v.available)
              .map(v => v.title)
              .join(", ");

            return {
              title: p.title,
              image: p.images[0]?.src || "https://via.placeholder.com/300?text=Sin+Imagen",
              imageHover: p.images[1]?.src || p.images[0]?.src,
              precio: precioFinal,
              tallas: tallas || "Sin tallas disponibles"
            };
          });

          productos = productos.concat(nuevos);
          page++;
        } catch (err) {
          console.error("Error cargando productos:", err);
          seguir = false;
        }
      }

      if (productos.length === 0) {
        contenedor.innerHTML = "<p class='text-danger'>No se pudieron cargar los productos.</p>";
        return;
      }

      mostrarProductos(productos);
    }

    function mostrarProductos(lista) {
      contenedor.innerHTML = "";
      lista.forEach(prod => {
        const col = document.createElement("div");
        col.classList.add("col");

        col.innerHTML = `
          <div class="card h-100">
            <div class="card-img-container">
              <img src="${prod.image}" alt="${prod.title}" class="main-img">
              <img src="${prod.imageHover}" alt="${prod.title}" class="hover-img">
            </div>
            <div class="card-body">
              <h5 class="card-title">${prod.title}</h5>
              <div class="card-price">$${prod.precio} MXN</div>
              <div class="card-sizes">Tallas: ${prod.tallas}</div>
            </div>
          </div>
        `;
        contenedor.appendChild(col);
      });
    }

    // Cargar productos automáticamente
    cargarProductos();
  });
</script>
